<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento Real a Gasf√≠teres con Google Maps API</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <!-- Incluir archivo CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Cargar la API de Google Maps con tu clave API -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNQPPM-69ZdtUwUKpUzoUTnS9u-5EGI-g&callback=initMap"></script>
</head>

<body>
  <div style="
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #555555;
  color: white;
  padding: 10px 20px;
  z-index: 1000;
  box-sizing: border-box;
  height: 60px;">

    <!-- Bot√≥n Volver -->
    <button id="backButton" style="
    background-color: #444;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    cursor: pointer;
    text-align: center;
    visibility: hidden;">
      &#8592; Volver
    </button>
    <!-- Bot√≥n Volver -->
    <button id="backCerrarSesion" style="
    background-color: #444;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    cursor: pointer;
    text-align: center;
    visibility: hidden;">
      &#8592; cerrar sesi√≥n
    </button>
    <!-- T√≠tulo centrado -->
    <span style="
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 20px;
    font-weight: bold;
    font-family: Arial, sans-serif;
    text-align: center;">
      HOGAR EN APUROS
    </span>

    <!-- Usuario Iniciado -->
    <span style="
    font-size: 16px;
    font-weight: bold;
    font-family: Arial, sans-serif;
    text-align: right;
    visibility: hidden;">
      Usuario_1
    </span>

  </div>

  <!-- Panel para seleccionar la ubicaci√≥n del gasf√≠ter -->
  <div id="panelUbicaci√≥n" style="display: none;">
    <h3>Seleccione un gasf√≠ter:</h3>
    <select id="gasfiterSelect"></select>

    <!-- Bot√≥n para calcular la ruta caminando -->
    <button id="drivingRouteBtn" onclick="calculateRoute('DRIVING')">Ruta Caminando</button>
  </div>

  <!-- Login cliente gasfiteer -->
  <div class="login-container" class="">
    <h2>Login</h2>
    <div class="form-group">
      <label for="username">Usuario:</label>
      <input type="text" id="username" placeholder="Ingrese su usuario">
    </div>
    <div class="form-group">
      <label for="password">Contrase√±a:</label>
      <input type="password" id="password" placeholder="Ingrese su contrase√±a">
    </div>
    <button id="login-button">Ingresar</button>
  </div>

  <!-- Pantalla principal -->
  <div id="mainScreen" style="display: none;">
    <h2>Bienvenido, <span id="userWelcome"></span></h2>
    <div class="button-container">
      <button id="btnNotifications" class="main-button">Ver Notificaciones</button>
      <button id="btnQuickSearch" class="main-button">B√∫squeda R√°pida</button>
      <button id="btnMap" class="main-button">Ver Mapa</button>
    </div>
  </div>

  <!-- Modal para la calendarizaci√≥n -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeScheduleModal()">&times;</span>
      <h2 id="scheduleTitle">Horarios de {{nombre del gasf√≠ter}}</h2>
      <div id="scheduleContainer" class="table-container"></div>
      <!-- Cambia el texto del bot√≥n a "Agendar Horario" -->
      <button id="confirmScheduleBtn" onclick="scheduleAppointment()">Agendar Horario</button>
    </div>
  </div>
  <div id="listadoGasfiter"
    style="display: none; width: 100%; height: 100vh; overflow-y: auto; border: none; padding: 0; margin: 0;">
    <h2
      style="font-family: Arial, sans-serif; text-align: center; margin: 20px 0; font-size: 1.5em; font-weight: bold;">
      Tabla de Gasf√≠teres</h2>
    <table
      style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 1em; text-align: left;">
      <thead style="background-color: #555555; color: white; position: sticky; top: 0; z-index: 1;">
        <tr>
          <th style="padding: 15px; border-bottom: 1px solid #ddd;">Gasf√≠ter</th>
          <th style="padding: 15px; border-bottom: 1px solid #ddd;">Fecha</th>
          <th style="padding: 15px; border-bottom: 1px solid #ddd;">Hora</th>
          <th style="padding: 15px; border-bottom: 1px solid #ddd;">Estado</th>
          <th style="padding: 15px; border-bottom: 1px solid #ddd;">Calificaci√≥n</th>
        </tr>
      </thead>
      <tbody id="citasTableBody" style="overflow-y: auto;">
        <!-- Filas generadas din√°micamente -->
      </tbody>
    </table>
  </div>

  </div>
  <!--listado de horas disponibles-->
  <div id="tablaAgendar" style="display: none; width: 100%; height: auto; margin: 0 auto; padding: 20px;">
    <h2
      style="font-family: Arial, sans-serif; text-align: center; margin: 20px 0; font-size: 1.5em; font-weight: bold;">
      Tabla de Agendamientos</h2>
    <table
      style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 1em; text-align: left; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <thead style="background-color: #555555; color: white; position: sticky; top: 0; z-index: 1;">
        <tr>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Hora</th>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Nombre</th>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Tiempo Estimado</th>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; text-align: center;">Agendar</th>
        </tr>
      </thead>
      <tbody id="agendarTableBody">
        <!-- Filas generadas din√°micamente -->
      </tbody>
    </table>
  </div>
  <div id="tablaChamba" style="display: none; width: 100%; height: auto; margin: 0 auto; padding: 20px;">
    <h2 id="textoCTabla"
      style="font-family: Arial, sans-serif; text-align: center; margin: 20px 0; font-size: 1.5em; font-weight: bold;">
      Tabla de Chamba</h2>

    <table id="tablaCContainer"
      style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 1em; text-align: left; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <thead style="background-color: #555555; color: white; position: sticky; top: 0; z-index: 1;">
        <tr>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Hora</th>
          <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Ruta</th>
          <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Nombre</th>
          <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Estado</th>
          <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Extensi√≥n</th>
          <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">Terminado</th>
        </tr>
      </thead>
      <tbody id="chambaTableBody">
        <!-- Filas din√°micas -->
      </tbody>
    </table>
    <!-- Modal para Extensi√≥n -->
    <!-- Modal para Extensi√≥n -->
    <div id="modalExtencion"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; display: none; justify-content: center; align-items: center;">
      <div
        style="background: #ffffff; width: 400px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 1px solid #ccc; font-family: Arial, sans-serif; position: relative;">

        <!-- Bot√≥n de cerrar -->
        <button onclick="cerrarModal()"
          style="position: absolute; top: 10px; right: 10px; background: #ddd; color: #555; border: none; border-radius: 50%; padding: 5px 10px; font-size: 14px; cursor: pointer;">
          &times;
        </button>

        <!-- T√≠tulo -->
        <h3 style="text-align: center; margin-bottom: 20px; font-size: 1.2em; color: #555; font-weight: bold;">
          Tiempo Extensi√≥n
        </h3>

        <!-- N√∫mero -->
        <div style="margin-bottom: 15px;">
          <label for="numeroExt" style="display: block; margin-bottom: 8px; color: #555;">N√∫mero:</label>
          <input type="number" id="numeroExt" value="0"
            style="width: calc(100% - 22px); padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; color: #333; background: #f9f9f9;">
        </div>

        <!-- Descripci√≥n -->
        <div style="margin-bottom: 20px;">
          <label for="descripcionExt" style="display: block; margin-bottom: 8px; color: #555;">Descripci√≥n:</label>
          <textarea id="descripcionExt" rows="4"
            style="width: calc(100% - 22px); padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; color: #333; background: #f9f9f9; resize: none;"></textarea>
        </div>

        <!-- Bot√≥n Guardar -->
        <div style="text-align: center;">
          <button onclick="guardarModal()"
            style="background-color: #555555; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
            Guardar
          </button>
        </div>
      </div>
    </div>
    <div id="mapContainer" style="
    width: 100%;
    height: 400px;
    margin: 20px auto;
    ">
      <h3 style="text-align: center; font-family: Arial, sans-serif; margin-bottom: 10px;">
        Mapa de la Ruta
      </h3>
      <div id="map" style="width: 100%; height: 100%; border: 1px solid #ddd; border-radius: 8px;"></div>
    </div>
    <!-- √çcono de Ruta -->
    <img src="https://cdn.icon-icons.com/icons2/2622/PNG/512/brand_google_maps_icon_157937.png" class="ruta-icon"
      alt="Ruta" style="width: 20px; height: 20px; cursor: pointer;">
  </div>
</body>

</html>
</body>

</html>
<script>
  let map, directionsService, directionsRenderer;
  let idUsuarioLogin = 0, idGasfiterLogin = 0, idCitasGasfiter = 0, idUsuarioCitas = 0, fechaCita, descripcionCita, reservasHoyGen, cantidadEnvioCorreo = 0;
  let idGasfiterSeleccion = 0;
  const gasfiterLocations = [];
  const fallbackLocation = { lat: -32.7295548, lng: -71.2084687 };  // Ubicaci√≥n fija de respaldo (casa)
  let userLocation = null;  // Para almacenar la ubicaci√≥n del usuario
  let reservasGen;
  // Lista de Usuarios con datos fijos
  let usuarios = [
    {
      name: 'Fabian Quintanilla',
      address: 'Calle Principal 123',
      email: 'fab.quintanilla@gmail.com',
      phone: '+56 9 12345678',
      location: { lat: -32.7206119, lng: -71.2042502 },
      id: 1
    },
    {
      name: 'Jonathan Quintanilla',
      address: 'Avenida del Sol 456',
      email: 'jon.quintanillac@gmail.com',
      phone: '+56 9 87654321',
      location: { lat: -32.732784, lng: -71.203833 },
      id: 2
    },
    {
      name: 'valeria Morales',
      address: 'Paseo de la Luz 789',
      email: 'valeriamoralesre@gmail.com',
      phone: '+56 9 11223344',
      location: { lat: -32.730794, lng: -71.207574 },
      id: 3
    },
    {
      name: 'karla nunez',
      address: 'Callej√≥n del R√≠o 321',
      email: 'karla.nuf@gmail.com',
      phone: '+56 9 55667788',
      location: { lat: -32.7318971, lng: -71.2056549 },
      id: 4
    },
    {
      name: 'Anival Gajardo',
      address: 'Calle Principal 654',
      email: 'fa.quintanilla@uandresbello.edu',
      phone: '+56 9 22334455',
      location: { lat: -32.740252, lng: -71.200637 },
      id: 5
    }
  ];
  // Lista de gasf√≠teres con datos fijos
  let gasfiters = [
    {
      name: 'Juan P√©rez',
      address: 'Calle Principal 123',
      email: 'juan.perez@gmail.com',
      phone: '+56 9 12345678',
      location: { lat: -32.73050, lng: -71.20383 }, // Coordenadas
      id: 1
    },
    {
      name: 'Sof√≠a Gonz√°lez',
      address: 'Avenida del Sol 456',
      email: 'sofia.gonzalez@yahoo.com',
      phone: '+56 9 87654321',
      location: { lat: -32.71408, lng: -71.23146 }, // Coordenadas
      id: 2
    },
    {
      name: 'Pedro Rodr√≠guez',
      address: 'Paseo de la Luz 789',
      email: 'pedro.rodriguez@hotmail.com',
      phone: '+56 9 11223344',
      location: { lat: -32.69545, lng: -71.21238 }, // Coordenadas
      id: 3
    },
    {
      name: 'Ana L√≥pez',
      address: 'Callej√≥n del R√≠o 321',
      email: 'ana.lopez@gmail.com',
      phone: '+56 9 55667788',
      location: { lat: -32.74885, lng: -71.21437 }, // Coordenadas
      id: 4
    },
    {
      name: 'Luis Mart√≠nez',
      address: 'Calle Principal 654',
      email: 'luis.martinez@gmail.com',
      phone: '+56 9 22334455',
      location: { lat: -32.69206, lng: -71.19529 }, // Coordenadas
      id: 5
    }
  ];
  function initMap() {
    // Usar la ubicaci√≥n de respaldo inicialmente para centrar el mapa
    const centerLocation = fallbackLocation;

    // Crear un nuevo mapa centrado en la ubicaci√≥n de respaldo
    map = new google.maps.Map(document.getElementById('map'));

    navigator.geolocation.getCurrentPosition(function (position) {
      var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);// {-32.7295548, -71.2084687}
      map.setCenter(initialLocation);
      map.setZoom(13);
    }, function (positionError) {
      map.setCenter(new google.maps.LatLng(39.8097343, -123.5556199));//-32.729554849432255, -71.20846874732048
      map.setZoom(5);
    });
    // map = new google.maps.Map(document.getElementById("map"), {
    //   zoom: 14,
    //   center: centerLocation,
    // });

    // Inicializar DirectionsService y DirectionsRenderer
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,  // Evitar que la API agregue sus propios marcadores
      polylineOptions: {
        strokeColor: '#0000FF',  // Color azul para la ruta
        strokeOpacity: 0.6,
        strokeWeight: 5
      }
    });
    directionsRenderer.setMap(map);
  }

  // Funci√≥n para obtener la ubicaci√≥n del usuario
  function getUserLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        console.log('Ubicaci√≥n actual del usuario obtenida:', userLocation);

        // Centrar el mapa en la ubicaci√≥n real del usuario
        map.setCenter(userLocation);

        // Colocar un marcador en la ubicaci√≥n del usuario
        new google.maps.Marker({
          position: userLocation,
          map: map,
          label: '',  // Marcador para la ubicaci√≥n del usuario
        });

        // Generar los gasf√≠teres alrededor de la ubicaci√≥n real
        generateGasfiterMarkers(userLocation);
      }, function () {
        console.warn('No se pudo obtener la ubicaci√≥n del usuario, usando la ubicaci√≥n de respaldo.');
        userLocation = fallbackLocation;  // Usar la ubicaci√≥n de respaldo si falla la geolocalizaci√≥n

        // Generar los gasf√≠teres alrededor de la ubicaci√≥n de respaldo
        generateGasfiterMarkers(userLocation);
      });
    } else {
      console.warn('Geolocalizaci√≥n no es compatible con este navegador, usando la ubicaci√≥n de respaldo.');
      userLocation = fallbackLocation;  // Usar la ubicaci√≥n de respaldo si la geolocalizaci√≥n no es compatible

      // Generar los gasf√≠teres alrededor de la ubicaci√≥n de respaldo
      generateGasfiterMarkers(userLocation);
    }
  }

  // Funci√≥n para obtener la ubicaci√≥n del usuario
  function getUserLocationGasfiterChamba() {
    const gasfiter = gasfiters.find((g) => g.id == idGasfiterLogin);
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        userLocation = gasfiter.location;
        console.log('Ubicaci√≥n actual del Gasfiter obtenida:', userLocation);

        // Centrar el mapa en la ubicaci√≥n real del usuario
        map.setCenter(userLocation);

        // Colocar un marcador en la ubicaci√≥n del usuario
        new google.maps.Marker({
          position: userLocation,
          map: map,
          label: '',  // Marcador para la ubicaci√≥n del usuario
        });

        // Generar los gasf√≠teres alrededor de la ubicaci√≥n real
        generateUsuarioMarkers(userLocation);
      }, function () {
        console.warn('No se pudo obtener la ubicaci√≥n del usuario, usando la ubicaci√≥n de respaldo.');
        userLocation = fallbackLocation;  // Usar la ubicaci√≥n de respaldo si falla la geolocalizaci√≥n

        // Generar los gasf√≠teres alrededor de la ubicaci√≥n de respaldo
        generateUsuarioMarkers(userLocation);
      });
    } else {
      console.warn('Geolocalizaci√≥n no es compatible con este navegador, usando la ubicaci√≥n de respaldo.');
      userLocation = fallbackLocation;  // Usar la ubicaci√≥n de respaldo si la geolocalizaci√≥n no es compatible

      // Generar los gasf√≠teres alrededor de la ubicaci√≥n de respaldo
      generateUsuarioMarkers(userLocation);
    }
  }


  // Funci√≥n para generar los marcadores de gasf√≠teres a partir de datos fijos
  function generateGasfiterMarkers() {
    const select = document.getElementById('gasfiterSelect');

    gasfiters.forEach(gasfiter => {
      // Crear marcador para cada gasf√≠ter con una ventana de informaci√≥n
      const marker = new google.maps.Marker({
        position: gasfiter.location,
        map: map,
        label: 'G' // Marcador de gasf√≠ter
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
        <div>
          <h3>${gasfiter.name}</h3>
          <p><strong>Direcci√≥n:</strong> ${gasfiter.address}</p>
          <p><strong>Correo:</strong> ${gasfiter.email}</p>
          <p><strong>Tel√©fono:</strong> ${gasfiter.phone}</p>
          <a href="#" onclick="openScheduleModal('${gasfiter.name}', '${gasfiter.id}')">Ver horarios</a>
        </div>
      `
      });

      // Mostrar la ventana de informaci√≥n al hacer clic en el marcador
      marker.addListener('click', function () {
        infoWindow.open(map, marker);
      });

      // A√±adir la direcci√≥n al select para que el usuario pueda elegir
      const option = document.createElement('option');
      option.value = JSON.stringify(gasfiter.location);
      option.text = `${gasfiter.name} - (${gasfiter.location.lat.toFixed(5)}, ${gasfiter.location.lng.toFixed(5)})`;
      select.appendChild(option);
    });
  }
  // Funci√≥n para generar los marcadores de gasf√≠teres a partir de datos fijos
  function generateUsuarioMarkers() {

    usuarios.forEach(usuario => {
      // Crear marcador para cada gasf√≠ter con una ventana de informaci√≥n
      const marker = new google.maps.Marker({
        position: usuario.location,
        map: map,
        label: 'U' // Marcador de gasf√≠ter
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
        <div>
          <h3>${usuario.name}</h3>
          <p><strong>Direcci√≥n:</strong> ${usuario.address}</p>
          <p><strong>Correo:</strong> ${usuario.email}</p>
          <p><strong>Tel√©fono:</strong> ${usuario.phone}</p>
        </div>
      `
      });

      // Mostrar la ventana de informaci√≥n al hacer clic en el marcador
      marker.addListener('click', function () {
        infoWindow.open(map, marker);
      });
    });
  }
  // Funci√≥n para generar una ubicaci√≥n aleatoria dentro de un radio
  function getRandomLocation(center, radius) {
    const earthRadius = 6371e3;  // Radio de la Tierra en metros
    const lat = center.lat * Math.PI / 180;  // Convertir a radianes
    const lng = center.lng * Math.PI / 180;

    // Calcular un √°ngulo y distancia aleatoria dentro del radio
    const randomDistance = Math.random() * radius;  // Distancia aleatoria dentro del radio
    const randomAngle = Math.random() * 2 * Math.PI;  // √Ångulo aleatorio en radianes

    // Calcular nueva ubicaci√≥n
    const deltaLat = randomDistance * Math.cos(randomAngle) / earthRadius;
    const deltaLng = randomDistance * Math.sin(randomAngle) / (earthRadius * Math.cos(lat));

    // Convertir de nuevo a grados
    const newLat = lat + deltaLat;
    const newLng = lng + deltaLng;

    return { lat: newLat * 180 / Math.PI, lng: newLng * 180 / Math.PI };
  }

  // Funci√≥n para calcular la ruta desde la ubicaci√≥n (real o de respaldo) hasta el gasf√≠ter seleccionado
  // Modo de viaje se pasa como par√°metro (por ejemplo, 'WALKING', 'DRIVING')
  function calculateRoute(travelMode = 'DRIVING') {
    const select = document.getElementById('gasfiterSelect');
    const selectedLocation = JSON.parse(select.value);  // Obtener la ubicaci√≥n seleccionada

    // Usar la ubicaci√≥n de respaldo si la ubicaci√≥n del usuario no est√° disponible
    const origin = userLocation || fallbackLocation;

    // Mostrar la ruta desde la ubicaci√≥n real (o de respaldo) hasta el gasf√≠ter seleccionado
    const request = {
      origin: origin,  // Ubicaci√≥n del usuario (o de respaldo)
      destination: selectedLocation,  // Ubicaci√≥n seleccionada del gasf√≠ter
      travelMode: travelMode  // Modo de viaje (por defecto 'DRIVING')
    };

    // Hacer la solicitud de ruta
    directionsService.route(request, function (result, status) {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);  // Mostrar la ruta en el mapa

        // Obtener la distancia usando DistanceMatrixService
        const distanceService = new google.maps.DistanceMatrixService();
        distanceService.getDistanceMatrix(
          {
            origins: [origin], // Punto de partida
            destinations: [selectedLocation], // Destino
            travelMode: travelMode, // Modo de transporte
          },
          function (response, status) {
            if (status === 'OK') {
              const distance = response.rows[0].elements[0].distance.text; // Distancia en texto (ejemplo: "12.3 km")
              const duration = response.rows[0].elements[0].duration.text; // Duraci√≥n en texto (ejemplo: "15 mins")

              alert(`Distancia: ${distance}, Tiempo estimado: ${duration}`);
              console.log(`Distancia: ${distance}, Tiempo estimado: ${duration}`);
            } else {
              console.error('Error al obtener la distancia: ' + status);
            }
          }
        );
      } else {
        alert('No se pudo calcular la ruta: ' + status);
      }
    });
  }
  function calculateRoutegasfiter(travelMode = 'DRIVING', selectedLocation) {
    console.log("entro")
    return new Promise((resolve, reject) => { // Define y retorna la Promesa
      const origin = userLocation || fallbackLocation;

      const request = {
        origin: origin,
        destination: selectedLocation,
        travelMode: travelMode,
      };

      // Inicializa el DistanceMatrixService
      const distanceService = new google.maps.DistanceMatrixService();
      distanceService.getDistanceMatrix(
        {
          origins: [origin],
          destinations: [selectedLocation],
          travelMode: travelMode,
        },
        function (response, status) {
          if (status === 'OK') {
            const distance = response.rows[0].elements[0].distance.text; // Ejemplo: "12.3 km"
            const duration = response.rows[0].elements[0].duration.text; // Ejemplo: "15 mins"
            resolve({ distance, duration }); // Devuelve un objeto con distancia y duraci√≥n
          } else {
            reject(`Error al obtener la distancia: ${status}`); // Manejo de error
          }
        }
      );
    });
  }
  // Funci√≥n para abrir el modal de horarios
  function openScheduleModal(name, idGasfiter) {

    idGasfiterSeleccion = idGasfiter;
    const modal = document.getElementById('scheduleModal');
    document.getElementById('scheduleTitle').innerText = `Horarios de ${name}`;
    generateScheduleTable(idGasfiter);
    modal.style.display = 'block';
  }

  // Funci√≥n para generar la tabla de horarios
  function generateScheduleTable(idGasfiter) {
    const container = document.getElementById('scheduleContainer');
    container.innerHTML = '';

    const table = document.createElement('table');
    table.className = 'schedule-table';

    const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
    const hours = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00','19:00','20:00'];

    // Obtener la fecha actual y ajustar para el lunes de la semana actual
    const today = new Date();
    const currentDay = today.getDay(); // 0 (Domingo) a 6 (S√°bado)
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1)); // Ajustar al lunes

    // Crear encabezado de la tabla
    const headerRow = document.createElement('tr');
    const emptyCell = document.createElement('th');
    headerRow.appendChild(emptyCell);

    days.forEach(day => {
      const th = document.createElement('th');
      th.innerText = day;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    // Crear filas de horas
    hours.forEach((hour) => {
      const row = document.createElement('tr');
      const hourCell = document.createElement('td');
      hourCell.innerText = hour;
      row.appendChild(hourCell);

      days.forEach((day, index) => {
        const cell = document.createElement('td');

        // Calcular la fecha correspondiente
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + index); // Sumar d√≠as al lunes
        const [year, month, date] = [
          cellDate.getFullYear(),
          String(cellDate.getMonth() + 1).padStart(2, '0'),
          String(cellDate.getDate()).padStart(2, '0')
        ];

        // Formatear hora
        const formattedHour = `${hour}:00`;
        const dateTime = `${year}/${month}/${date} ${formattedHour}`;
        const dateTime2 = new Date(`${year}-${month}-${date}T${formattedHour}`); // Fecha y hora de la celda
        // Verificar si la hora ya pas√≥
        const isPast = dateTime2 < today;

        // Verificar si la celda est√° reservada
        const isReserved = reservasGen.some((reserva) => {
          return reserva.dayIndex == index + 1 && reserva.hour == hour && reserva.idGasfiter == idGasfiter;
        });
        // Verificar si la celda est√° reservada
        const isReservedUser = reservasGen.some((reserva) => {
          return reserva.dayIndex == index + 1 && reserva.hour == hour && reserva.idGasfiter == idGasfiter && reserva.idUsuario == idUsuarioLogin;
        });
        if (isPast) {
          cell.className = 'past';
          cell.innerText = 'no habil';
        } else if (isReservedUser) {
          cell.className = 'pending';
          cell.innerText = 'Reservado';
        } else if (isReserved) {
          cell.className = 'unavailable';
          cell.innerText = 'No Disponible';
        } else {
          cell.className = 'available';
          cell.innerText = 'Disponible';
          cell.onclick = () => toggleCell(cell);
        }

        // Agregar el texto oculto con data-datetime
        cell.setAttribute('data-datetime', dateTime);

        row.appendChild(cell);
      });

      table.appendChild(row);
    });

    container.appendChild(table);
  }



  // Funci√≥n para alternar la selecci√≥n de celdas de la tabla
  function toggleCell(cell) {
    if (cell.classList.contains('available')) {
      cell.classList.remove('available');
      cell.classList.add('confirmed');
      cell.innerText = 'Confirmado';
    } else if (cell.classList.contains('confirmed')) {
      cell.classList.remove('confirmed');
      cell.classList.add('available');
      cell.innerText = 'Disponible';
    }
  }

  // Funci√≥n para cerrar el modal de horarios
  function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
  }
  let selectedCell = null;  // Almacenar la celda seleccionada

  // Funci√≥n para alternar la selecci√≥n de celdas de la tabla
  function toggleCell(cell) {
    if (cell.classList.contains('available')) {
      // Deseleccionar cualquier celda previamente seleccionada
      if (selectedCell) {
        selectedCell.classList.remove('selected');
        selectedCell.classList.add('available');
        selectedCell.innerText = 'Disponible';
      }

      // Seleccionar la nueva celda
      cell.classList.remove('available');
      cell.classList.add('selected');
      cell.innerText = 'Seleccionado';
      selectedCell = cell;  // Guardar la celda seleccionada
    }
  }

  // Funci√≥n para confirmar y guardar el horario seleccionado
  function confirmSchedule() {
    if (selectedCell) {
      // Cambiar la clase a 'confirmed' para indicar que el horario est√° reservado
      selectedCell.classList.remove('selected');
      selectedCell.classList.add('confirmed');
      selectedCell.innerText = 'Confirmado';

      // Guardar la informaci√≥n del horario en el backend o localmente
      saveSchedule(selectedCell);  // Llama a una funci√≥n para guardar el horario

      // Resetear la selecci√≥n
      selectedCell = null;
      
      alert('Horario confirmado exitosamente.');
    } else {
      alert('Por favor, selecciona un horario antes de confirmar.');
    }
  }

  // Funci√≥n para cerrar el modal de horarios
  function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
  }
  // Funci√≥n para transformar citas en formato reservas
  const transformCitasToReservas = (citas) => {
    return citas.map(cita => {
      const fecha = new Date(cita.Fecha);
      return {
        dayIndex: fecha.getDay(), // Devuelve el √≠ndice del d√≠a (0 = Domingo, 6 = S√°bado)
        hour: cita.Fecha.split(' ')[1].slice(0, 5), // Extrae HH:mm de la fecha
        idGasfiter: cita.idgasfiter,
        idUsuario: cita.idUsuario,
        fecha: cita.Fecha,
        estado: cita.Estado,
        idCitas: cita.idCitas,
        descripcion: cita.descripcion,
        calificacion: cita.calificacion
      };
    });
  };

  async function fetchReservas() {
    try {
      const response = await new Promise((resolve, reject) => {
        $.ajax({
          url: "http://localhost:5000/api/citas",
          method: "GET",
          timeout: 0,
          success: function (data) {
            resolve(data); // Devuelve los datos al resolver la promesa
          },
          error: function (jqXHR, textStatus, errorThrown) {
            reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa con el error
          }
        });
      });

      console.log(response);

      // Transformar citas
      const reservas = transformCitasToReservas(response);
      reservasGen = reservas;
      console.log(reservas);
    } catch (error) {
      console.error('Error al obtener reservas:', error);
    }
  }

  // Llamar a la funci√≥n
  fetchReservas();

  function scheduleAppointment() {
    // Obtener la celda seleccionada del calendario
    const selectedCell = document.querySelector('.schedule-table td.selected');
    console.log("idUsuarioLogin", idUsuarioLogin)
    if (!selectedCell) {
      alert('Por favor, selecciona una fecha y hora antes de agendar.');
      return;
    }

    // Obtener el valor de data-datetime de la celda seleccionada
    const selectedDateTime = selectedCell.getAttribute('data-datetime');

    // Datos para el POST
    const settings = {
      "url": "http://localhost:5000/api/citas",
      "method": "POST",
      "timeout": 0,
      "headers": {
        "Content-Type": "application/json"
      },
      "data": JSON.stringify({
        "idUsuario": idUsuarioLogin, // Puedes reemplazar esto con el ID del usuario actual
        "idgasfiter": idGasfiterSeleccion, // Tambi√©n puedes obtener este ID din√°micamente si lo necesitas
        "Fecha": selectedDateTime, // Fecha obtenida de la celda seleccionada
        "Estado": 1,
        "calificacion": 0
      }),
    };

    // Enviar la solicitud AJAX
    $.ajax(settings).done(function (response) {
      console.log(response);
      alert('Cita agendada con √©xito.');
      selectedCell.classList.remove('selected');
      selectedCell.classList.remove('available');
      selectedCell.classList.add('pending');
      selectedCell.innerText = 'Reservado';
      document.getElementById('scheduleModal').style.display = 'none';
      fetchReservas();
    }).fail(function (error) {
      console.error(error);
      alert('Hubo un error al agendar la cita.');
    });
  }

  async function guardarCalificacion(reservaId) {
    const input = document.getElementById(`calificacion-${reservaId}`);
    const guardarBtn = document.getElementById(`guardar-${reservaId}`);
    const calificacion = parseInt(input.value);

    if (calificacion >= 1 && calificacion <= 7) {

      // Aqu√≠ puedes a√±adir la l√≥gica para guardar la calificaci√≥n en el backend o en una variable global
      const settings = {
        url: "http://localhost:5000/api/citas/calificacion",
        method: "POST",
        timeout: 0,
        headers: {
          "Content-Type": "application/json",
        },
        data: JSON.stringify({
          idCitas: reservaId,
          calificacion: input.value,
        }),
      };

      // Realizar la solicitud AJAX y esperar a que termine
      const response = await new Promise((resolve, reject) => {
        $.ajax({
          ...settings,
          success: function (data) {
            fetchReservas();
            resolve(data); // Resuelve la promesa si la llamada es exitosa
          },
          error: function (jqXHR, textStatus, errorThrown) {
            reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
          },
        });
      });
      console.log(`Calificaci√≥n guardada para la reserva ${reservaId}: ${calificacion}`);
      input.disabled = true;
      guardarBtn.disabled = true;
      guardarBtn.style.backgroundColor = 'gray';
      guardarBtn.style.cursor = 'not-allowed';

    } else {
      alert('Por favor, ingresa una calificaci√≥n v√°lida (entre 1 y 7).');
    }
  }
  $(document).ready(function () {
    $('#login-button').click(function () {
      const username = $('#username').val();
      const password = $('#password').val();

      const extractLastNumber = (str) => {
        const match = str.match(/_(\d+)$/); // Ajustado para buscar el √∫ltimo n√∫mero despu√©s de _
        return match ? parseInt(match[1], 10) : null; // Convertir a n√∫mero si se encuentra
      };
      if (
        (username === 'usuario_1' || username === 'usuario_2' || username === 'usuario_3' || username === 'usuario_4' || username === 'usuario_5') &&

        password === '1234'
      ) {
        $('.login-container').css('display', 'none');
        $('#mainScreen').css('display', 'block');
        $('#backCerrarSesion').css('visibility', 'visible');
        $('#backCerrarSesion').css('display', 'block');
        $('#backButton').css('display', 'none');
        $('#password').val("");
        initMap()
        idUsuarioLogin = extractLastNumber(username);
        fetchReservas();
        // Intentar obtener la ubicaci√≥n real del usuario
        getUserLocation();
      }
      else if ((username === 'gasfiter_1' || username === 'gasfiter_2' || username === 'gasfiter_3' || username === 'gasfiter_3' || username === 'gasfiter_3') &&

        password === 'qwer') {
        $('.login-container').css('display', 'none');
        $('#panelGasfiter').css('display', 'block');
        $('#backCerrarSesion').css('visibility', 'visible');
        $('#backCerrarSesion').css('display', 'block');
        $('#backButton').css('display', 'none');
        $('#password').val("");
        $('#tablaChamba').css('display', 'block');
        $('#map').css('display', 'block');
        $('#mapContainer').css('display', 'block');
        // Llamada inicial
        idGasfiterLogin = extractLastNumber(username);
        fetchReservas();
        initMap()
        getUserLocationGasfiterChamba()
        cantidadEnvioCorreo = 0;
        renderizarTablaChamba();
      }
      else {
        alert('Credenciales incorrectas o tipo de usuario no v√°lido.');
      }
    });
    $('#btnMap').click(function () {
      $('#map').css('display', 'block');
      $('#mapContainer').css('display', 'block');
      $('#mainScreen').css('display', 'none');
      $('#backButton').css('visibility', 'visible');
      $('#backButton').css('display', 'block');
      $('#backCerrarSesion').css('display', 'none');
      $('#backCerrarSesion').css('visibility', 'hidden');
      $('#tablaChamba').css('display', 'block');
      $('#textoCTabla').css('display', 'none');
      $('#tablaCContainer').css('display', 'none');
    });
    $('#btnNotifications').click(function () {
      $('#listadoGasfiter').css('display', 'block');
      $('#mainScreen').css('display', 'none');
      $('#backButton').css('visibility', 'visible');
      $('#backButton').css('display', 'block');
      $('#backCerrarSesion').css('display', 'none');
      $('#backCerrarSesion').css('visibility', 'hidden');
      mostrarReservasPaginadas();

    });

    // Funci√≥n para guardar la calificaci√≥n

    $('#btnQuickSearch').click(async function () {
      $('#tablaAgendar').css('display', 'block');
      $('#mainScreen').css('display', 'none');
      $('#backButton').css('visibility', 'visible');
      $('#backButton').css('display', 'block');
      $('#backCerrarSesion').css('display', 'none');
      $('#backCerrarSesion').css('visibility', 'hidden');
      await updateGasfitersWithDistance();
      await generarListadoGasfiterRapido();
    });
    $('#backButton').click(function () {
      $('#mainScreen').css('display', 'block');
      $('#map').css('display', 'none');
      $('#mapContainer').css('display', 'none');
      $('#listadoGasfiter').css('display', 'none');
      $('#tablaAgendar').css('display', 'none');
      $('#backButton').css('display', 'none');
      $('#backButton').css('visibility', 'hidden');
      $('#backCerrarSesion').css('visibility', 'visible');
      $('#backCerrarSesion').css('display', 'block');
      $('#tablaChamba').css('display', 'none');
      $('#textoCTabla').css('display', 'block');
      $('#tablaCContainer').css('display', 'inline-table');
    });
    $('#backCerrarSesion').click(function () {
      $('#mainScreen').css('display', 'none');
      $('#tablaChamba').css('display', 'none');
      $('.login-container').css('display', 'block');
      $('#backCerrarSesion').css('display', 'none');
      $('#backCerrarSesion').css('visibility', 'hidden');
      $('#backButton').css('display', 'block');
      $('#backButton').css('visibility', 'hidden');
      $('#map').css('display', 'none');
      $('#mapContainer').css('display', 'none');
    });

    $('#nextPageButton').click(function () {
      $('#mainScreen').css('display', 'none');
      $('.next-container').css('display', 'block');
      $('#nextPageButton').css('display', 'none');
      $('#nextPageButton').css('visibility', 'hidden');
      $('#backButton').css('display', 'block');
      $('#backButton').css('visibility', 'visible');
    });
    $('.ruta-icon').click(function () {
      $('#mainScreen').css('display', 'none');
      $('.ruta-container').css('display', 'block');
      $('.ruta-icon').css('display', 'none');
      $('.ruta-icon').css('visibility', 'hidden');
      $('#backButton').css('display', 'block');
      $('#backButton').css('visibility', 'visible');
    });
  });
  function mostrarReservasPaginadas() {
    const tableBody = document.getElementById('citasTableBody');
    tableBody.innerHTML = ''; // Limpia el contenido actual de la tabla

    // Filtrar y ordenar las reservas
    const reservasFiltradas = reservasGen
      .filter((reserva) => reserva.idUsuario == idUsuarioLogin) // Filtrar por usuario
      .sort((a, b) => {
        const fechaHoraA = new Date(a.fecha); // Fecha ya tiene la hora incluida
        const fechaHoraB = new Date(b.fecha);
        return fechaHoraB - fechaHoraA; // Ordena descendente (mayor a menor)
      });

    // Mostrar las filas
    reservasFiltradas.forEach((reserva, index) => {
      const gasfiter = gasfiters.find((g) => g.id === parseInt(reserva.idGasfiter));
      const dateParts = reserva.fecha.split(' ');
      const fecha = dateParts[0];
      const hora = dateParts[1];
      let estadoIcon = '';

      // Iconos de estado
      switch (reserva.estado) {
        case '3':
          estadoIcon = `<span style="color: green; font-weight: bold;">‚úÖ</span>`;
          break;
        case '2':
          estadoIcon = `<img src="https://cdn-icons-png.flaticon.com/512/4635/4635159.png" alt="Herramienta" style="width: 20px; height: 20px;" title="Trabajando">`;
          break;
        case '1':
          estadoIcon = `<span style="color: gray; font-weight: bold;">‚ûñ</span>`;
        default:
          estadoIcon = `<span style="color: red; font-weight: bold;">‚ùå</span>`;
      }
      const calificacion = reserva.calificacion == null || reserva.calificacion == 0 ? "" : reserva.calificacion;

const row = `
    <tr style="background-color: ${index % 2 == 0 ? 'white' : '#f2f2f2'};">
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${gasfiter ? gasfiter.name : 'Desconocido'}</td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${fecha}</td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${hora}</td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${estadoIcon}</td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
            ${reserva.estado == '3' ? `
                <input type="number" id="calificacion-${reserva.idCitas}" 
                       min="1" max="7" 
                       style="width: 60px; text-align: center;" 
                       value="${calificacion}"
                       ${reserva.calificacion != null && reserva.calificacion != 0 ? 'disabled' : ''}>
                <button onclick="guardarCalificacion('${reserva.idCitas}')" id="guardar-${reserva.idCitas}" 
                        style="background-color: ${reserva.calificacion !== null && reserva.calificacion !== 0 ? 'gray' : '#444'}; 
                               color: white; 
                               border: none; 
                               border-radius: 5px; 
                               padding: 5px 10px; 
                               cursor: ${reserva.calificacion != null && reserva.calificacion != 0 ? 'not-allowed' : 'pointer'};" 
                        ${reserva.calificacion != null && reserva.calificacion != 0 ? 'disabled' : ''}>
                    Guardar
                </button>
            ` : ''}
        </td>
    </tr>
`;
      tableBody.innerHTML += row;
    });
  }
  function generarListadoGasfiterRapido() {
    // Funci√≥n auxiliar para convertir "1 h 5 min" a minutos
    function convertirDurationAMinutos(duration) {
      let totalMinutos = 0;
      if (duration.includes('h')) {
        const [horas, resto] = duration.split('h');
        totalMinutos += parseInt(horas.trim()) * 60;
        if (resto) totalMinutos += parseInt(resto.replace('min', '').trim());
      } else {
        totalMinutos += parseInt(duration.replace('min', '').trim());
      }
      return totalMinutos;
    }

    // Ordenar gasfiters por duraci√≥n de menor a mayor
    const gasfitersOrdenados = gasfiters.sort((a, b) => {
      const duracionA = convertirDurationAMinutos(a.duration || "0 min"); // Aseguramos un valor por defecto
      const duracionB = convertirDurationAMinutos(b.duration || "0 min");
      return duracionA - duracionB;
    });

    const ahora = new Date();
    ahora.setHours(ahora.getHours() + 1); // A√±adir una hora
    ahora.setMinutes(0, 0, 0); // Reiniciar los minutos y segundos a 00
    const horaSiguiente = ahora.toTimeString().slice(0, 5);

    const fechaActual = new Date().toISOString().split('T')[0];
    const dayIndexActual = new Date().getDay();
    const resultados = [];

    // Buscar resultados sin reservas para la hora siguiente
    gasfitersOrdenados.forEach((gasfiter) => {
      const registro = reservasGen.find((entry) => {
        return (
          entry.dayIndex === dayIndexActual &&
          entry.hour === horaSiguiente &&
          entry.idGasfiter == gasfiter.id
        );
      });

      if (!registro) {
        resultados.push({
          hora: horaSiguiente,
          nombre: gasfiter.name,
          idGasfiter: gasfiter.id,
          horaEstimada: gasfiter.duration,
        });
      }
    });

    // Insertar en la tabla
    const agendarTableBody = document.getElementById('agendarTableBody');
    agendarTableBody.innerHTML = ''; // Limpiar el contenido previo

    resultados.forEach((resultado, index) => {
      const row = `
      <tr style="background-color: ${index % 2 === 0 ? 'white' : '#f2f2f2'};">
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${resultado.hora}</td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${resultado.nombre}</td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${resultado.horaEstimada}</td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
          <button 
            style="background-color: #007bff; color: white; border: none; border-radius: 5px; padding: 10px; cursor: pointer;" 
            onclick="insertGastiferIdHour(${resultado.idGasfiter}, '${resultado.hora}', this)">
            üìÖ
          </button>
        </td>
      </tr>
    `;
      agendarTableBody.innerHTML += row;
    });

    console.log("Gasfiters ordenados:", gasfitersOrdenados);
  }
  async function insertGastiferIdHour(idGasfiter, hora, button) {
    // Obtener el valor de data-datetime de la celda seleccionada
    const selDateTime = addHour(hora); // A√±ade la hora a la fecha actual

    // Datos para el POST
    const settings = {
      "url": "http://localhost:5000/api/citas",
      "method": "POST",
      "timeout": 0,
      "headers": {
        "Content-Type": "application/json",
      },
      "data": JSON.stringify({
        "idUsuario": idUsuarioLogin, // Puedes reemplazar esto con el ID del usuario actual
        "idgasfiter": idGasfiter, // Tambi√©n puedes obtener este ID din√°micamente si lo necesitas
        "Fecha": selDateTime, // Fecha obtenida de la celda seleccionada
        "Estado": 1,
        "calificacion": 0
      }),
    };

    // Enviar la solicitud AJAX
    $.ajax(settings).done(function (response) {
      console.log(response);
      alert('Cita agendada con √©xito.');
      // Eliminar la fila del bot√≥n presionado
      const row = button.closest('tr'); // Acceder a la fila padre del bot√≥n
      row.remove(); // Eliminar la fila del DOM
    }).fail(function (error) {
      console.error(error);
      alert('Hubo un error al agendar la cita.');
    });
  }
  function addHour(hora) {
    const [hours, minutes] = hora.split(':'); // Separar horas y minutos
    const now = new Date(); // Obtener la fecha actual
    now.setHours(parseInt(hours, 10)); // Establecer las horas
    now.setMinutes(parseInt(minutes, 10)); // Establecer los minutos
    now.setSeconds(0, 0); // Establecer los segundos a 0

    // Formatear la fecha como YYYY/MM/DD HH:mm:ss
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0'); // Mes comienza en 0
    const day = String(now.getDate()).padStart(2, '0');
    const formattedHour = String(now.getHours()).padStart(2, '0');
    const formattedMinutes = String(now.getMinutes()).padStart(2, '0');
    const formattedSeconds = String(now.getSeconds()).padStart(2, '0');

    return `${year}/${month}/${day} ${formattedHour}:${formattedMinutes}:${formattedSeconds}`;
  }
  // Funci√≥n para actualizar los objetos en `gasfiters` con distancia y duraci√≥n
  async function updateGasfitersWithDistance() {
    for (const gasfiter of gasfiters) {
      try {
        const result = await calculateRoutegasfiter('WALKING', gasfiter.location); // Espera los datos de distancia y duraci√≥n
        gasfiter.distance = result.distance; // Agregar distancia al objeto
        gasfiter.duration = result.duration; // Agregar duraci√≥n al objeto
        console.log(`Actualizado: ${gasfiter.name} -> Distancia: ${result.distance}, Duraci√≥n: ${result.duration}`);
      } catch (error) {
        console.error(`Error actualizando ${gasfiter.name}: ${error}`);
      }
    }
    // Llama a la funci√≥n para actualizar la lista de gasfiters
    console.log('Todos los gasfiters actualizados:', gasfiters);
  }
  // Funciones
  function calcularRuta(travelMode = 'DRIVING', selectedLocation1, selectedLocation2) {
    console.log("entro")
    return new Promise((resolve, reject) => { // Define y retorna la Promesa
      const origin = userLocation || fallbackLocation;
      const Gasfiter = gasfiters.find((listaGasfiters) => listaGasfiters.id == idGasfiterLogin);
      let selectedLocation = { lat: selectedLocation1, lng: selectedLocation2 };
      const request = {
        origin: Gasfiter.location,
        destination: selectedLocation,
        travelMode: travelMode,
      };

      // Hacer la solicitud de ruta
      directionsService.route(request, function (result, status) {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);  // Mostrar la ruta en el mapa

          // Obtener la distancia usando DistanceMatrixService
          const distanceService = new google.maps.DistanceMatrixService();
          distanceService.getDistanceMatrix(
            {
              origins: [origin], // Punto de partida
              destinations: [selectedLocation], // Destino
              travelMode: travelMode, // Modo de transporte
            },
            function (response, status) {
              if (status === 'OK') {
                const distance = response.rows[0].elements[0].distance.text; // Distancia en texto (ejemplo: "12.3 km")
                const duration = response.rows[0].elements[0].duration.text; // Duraci√≥n en texto (ejemplo: "15 mins")

                alert(`Distancia: ${distance}, Tiempo estimado: ${duration}`);
                console.log(`Distancia: ${distance}, Tiempo estimado: ${duration}`);
              } else {
                console.error('Error al obtener la distancia: ' + status);
              }
            }
          );
        } else {
          alert('No se pudo calcular la ruta: ' + status);
        }
      });
    });
  }

  function actualizarData() {
    alert('Actualizaci√≥n de extensi√≥n iniciada');
  }

  function renderizarTablaChamba() {
    const tableBody = document.getElementById('chambaTableBody');
    tableBody.innerHTML = '';

    // Ajustar fecha actual seg√∫n zona horaria local
    const hoy = new Date();
    const fechaActual = new Date(hoy.getTime() - hoy.getTimezoneOffset() * 60000)
      .toISOString()
      .split('T')[0]; // YYYY-MM-DD

    console.log('Fecha actual ajustada:', fechaActual);

    // Filtrar reservas del d√≠a actual
    const reservasHoy = reservasGen.filter((item) => {
      const itemFecha = item.fecha.split(' ')[0].replace(/\//g, '-'); // Convertir formato "YYYY/MM/DD" a "YYYY-MM-DD"
      return itemFecha === fechaActual && item.idGasfiter == idGasfiterLogin; // Coincidencia por fecha y gasfiter
    });
    reservasHoyGen = reservasHoy;
    // Generar filas din√°micamente
    reservasHoy.forEach((item, index) => {
      const usuario = usuarios.find((user) => user.id == item.idUsuario);
      const hora = item.fecha.split(' ')[1]; // Extraer solo la hora (HH:MM:SS)
      let estadoIcon;
      let isChecked = '';
      switch (item.estado) {
        case '1':
          estadoIcon = `<img src="https://e7.pngegg.com/pngimages/599/208/png-clipart-shoe-footprint-computer-icons-hiking-shoe-fashion-logo.png" 
                      alt="En movimiento" style="width: 20px; height: 20px;" title="En movimiento">`;
          break;
        case '2':
          estadoIcon = `<img src="https://cdn-icons-png.flaticon.com/512/4635/4635159.png" 
                      alt="Herramienta" style="width: 20px; height: 20px;" title="Trabajando">`;
          break;
        case '3':
          estadoIcon = '‚úÖ'; // Ticket verde
          isChecked = 'checked';
          break;
        default:
          estadoIcon = '‚è≥'; // Por defecto un icono de reloj
      }
      // Determinar si el checkbox debe estar seleccionado (checked)

      const row = `
      <tr style="background-color: ${index % 2 == 0 ? 'white' : '#f2f2f2'};">
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${hora}</td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
          <img src="https://cdn.icon-icons.com/icons2/2622/PNG/512/brand_google_maps_icon_157937.png" 
            alt="Ruta" style="width: 20px; height: 20px; cursor: pointer;" onclick="calcularRuta('DRIVING',${usuario.location.lat},${usuario.location.lng})">
        </td>
        <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">${usuario ? usuario.name : 'Desconocido'}</td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">${estadoIcon}</td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
          <img src="https://png.pngtree.com/png-clipart/20230330/original/pngtree-clock-line-icon-png-image_9012699.png" 
            alt="Extensi√≥n" style="width: 20px; height: 20px; cursor: pointer;" onclick="abrirModal(${item.idCitas},${item.idUsuario},'${item.fecha}','${item.descripcion}')">
        </td>
        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
            <input type="checkbox" ${isChecked} onclick="cambiarEstado(${item.idCitas}, this.checked,${item.idUsuario},'${item.fecha}')">
          </td>
      </tr>
    `;

      tableBody.innerHTML += row;
    });

    if (reservasHoy.length == 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 12px;">No hay reservas para hoy.</td></tr>`;
    }
  }
  async function cambiarEstado(idCitas, terminado, idUsuario, fecha) {
    console.log(`Cita ${idCitas} termin√≥: ${terminado}`);

    let estado = 1;
    if (terminado) {
      estado = 3;
      const usuario = usuarios.find((user) => user.id == idUsuario);
      const Gasfiter = gasfiters.find((listaGasfiters) => listaGasfiters.id == idGasfiterLogin);
      const settingsSendMail = {
        url: "http://localhost:5000/api/citas/send-email",
        method: "POST",
        headers: { "Content-Type": "application/json" },
        data: JSON.stringify({
          to: usuario.email,
          subject: "Termino de trabajo",
          text: "Estimado Usuario su Gasfiter " + Gasfiter.name + " a Finalizado su trabajo de las " + fecha + ",favor realizar su calificaci√≥n"
        }),
      };
      console.log("settingsSendMail", settingsSendMail)
      if (cantidadEnvioCorreo <= 2) {
        cantidadEnvioCorreo = cantidadEnvioCorreo + 1;
        const responseSendMail = await new Promise((resolve, reject) => {
          $.ajax({
            ...settingsSendMail,
            success: function (data) {
              resolve(data); // Resuelve la promesa si la llamada es exitosa
            },
            error: function (jqXHR, textStatus, errorThrown) {
              reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
            },
          });
        });
      }
    } else {
      estado = 2;
    }
    const settingsUpdateEstado = {
      url: "http://localhost:5000/api/citas/updateEstado",
      method: "POST",
      headers: { "Content-Type": "application/json" },
      data: JSON.stringify({
        idCitas: idCitas,
        Estado: estado
      }),
    };
    console.log("settingsUpdateEstado", settingsUpdateEstado)
    const responseUpdateEstado = await new Promise((resolve, reject) => {
      $.ajax({
        ...settingsUpdateEstado,
        success: function (data) {
          resolve(data); // Resuelve la promesa si la llamada es exitosa
        },
        error: function (jqXHR, textStatus, errorThrown) {
          reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
        },
      });
    });
  }
  // Funci√≥n para abrir el modal
  function abrirModal(idCitas, idUsuario, fecha, descripcion) {
    document.getElementById('modalExtencion').style.display = 'flex';
    idCitasGasfiter = idCitas;
    idUsuarioCitas = idUsuario;
    fechaCita = fecha;
    descripcionCita = descripcion;
    document.getElementById('descripcionExt').value = descripcionCita;
  }

  // Funci√≥n para cerrar el modal
  function cerrarModal() {
    document.getElementById('modalExtencion').style.display = 'none';
  }
  async function guardarModal() {
    try {
      // Obtener valores del modal

      const descripcion = document.getElementById('descripcionExt').value; // Descripci√≥n ingresada
      const horasExtras = document.getElementById('numeroExt').value; // Descripci√≥n ingresada
      // Datos para el POST
      // Verificar selectedDateTime
      if (!fechaCita) throw new Error("selectedDateTime no est√° definido.");

      let fechaCitaSet = new Date(convertirAFechaISO(fechaCita));

      if (isNaN(fechaCitaSet.getTime())) {
        throw new Error("selectedDateTime no es una fecha v√°lida.");
      }

      for (let i = 0; i < horasExtras; i++) {
        fechaCitaSet.setHours(fechaCitaSet.getHours() + 1); // Sumar una hora
        let formatFechaSet = formatFecha(fechaCitaSet)
        for (const item of reservasHoyGen) {
          const usuario = usuarios.find((user) => user.id == item.idUsuario);
          const Gasfiter = gasfiters.find((listaGasfiters) => listaGasfiters.id == idGasfiterLogin);
          if (item.fecha == formatFechaSet && item.idGasfiter == idGasfiterLogin && item.idUsuario != idUsuarioCitas) {
            console.log("item.idCitas", item.idCitas)
            console.log("usuario", usuario.email)
            const settingsSendMail = {
              url: "http://localhost:5000/api/citas/send-email",
              method: "POST",
              headers: { "Content-Type": "application/json" },
              data: JSON.stringify({
                to: usuario.email,
                subject: "Eliminacion de Cita",
                text: "Estimado Usuario su Gasfiter " + Gasfiter.name + " a eliminado su cita de las " + formatFechaSet.toString() + ",favor reagendar"
              }),
            };
            console.log("settingsSendMail", settingsSendMail)
            const responseSendMail = await new Promise((resolve, reject) => {
              $.ajax({
                ...settingsSendMail,
                success: function (data) {
                  resolve(data); // Resuelve la promesa si la llamada es exitosa
                },
                error: function (jqXHR, textStatus, errorThrown) {
                  reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
                },
              });
            });


            const settingsDelete = {
              url: "http://localhost:5000/api/citas/delete",
              method: "POST",
              headers: { "Content-Type": "application/json" },
              data: JSON.stringify({
                id: item.idCitas
              }),
            };
            console.log("settingsDelete", settingsDelete)
            const responseDelete = await new Promise((resolve, reject) => {
              $.ajax({
                ...settingsDelete,
                success: function (data) {
                  resolve(data); // Resuelve la promesa si la llamada es exitosa
                },
                error: function (jqXHR, textStatus, errorThrown) {
                  reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
                },
              });
            });

          }
        };

        const reser = reservasHoyGen.find((listaReserva) => listaReserva.idGasfiter == idGasfiterLogin && listaReserva.fecha == formatFechaSet && listaReserva.idUsuario == idUsuarioCitas);
        if (reser) {
          console.log("no inserta dato nuevo");
        } else {
          console.log("inserta dato nuevo");
          const settingsInsert = {
            url: "http://localhost:5000/api/citas",
            method: "POST",
            headers: { "Content-Type": "application/json" },
            data: JSON.stringify({
              idUsuario: idUsuarioCitas,
              idgasfiter: idGasfiterLogin,
              Fecha: formatFechaSet,
              Estado: 2,
              calificacion: 0,
            }),
          };
          console.log("settingsInsert", settingsInsert)
          const response = await new Promise((resolve, reject) => {
            $.ajax({
              ...settingsInsert,
              success: function (data) {
                resolve(data); // Resuelve la promesa si la llamada es exitosa
              },
              error: function (jqXHR, textStatus, errorThrown) {
                reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
              },
            });
          });
        }


      }

      // Configuraci√≥n de la solicitud AJAX

      const settings = {
        url: "http://localhost:5000/api/citas/update",
        method: "POST",
        timeout: 0,
        headers: {
          "Content-Type": "application/json",
        },
        data: JSON.stringify({
          idCitas: idCitasGasfiter, // N√∫mero ingresado en el modal
          Estado: "2", // Cambia el estado a 2 (trabajando)
          descripcion: descripcion, // Descripci√≥n ingresada en el modal
        }),
      };

      // Realizar la solicitud AJAX y esperar a que termine
      const response = await new Promise((resolve, reject) => {
        $.ajax({
          ...settings,
          success: function (data) {
            resolve(data); // Resuelve la promesa si la llamada es exitosa
          },
          error: function (jqXHR, textStatus, errorThrown) {
            reject(`Error: ${textStatus} - ${errorThrown}`); // Rechaza la promesa si hay un error
          },
        });
      });
      document.getElementById('descripcionExt').value = ""; // Limpiar el campo descripcionExt
      document.getElementById('numeroExt').value = "";      // Limpiar el campo numeroExt
      console.log("Actualizaci√≥n exitosa:", response);
      alert("Los datos se guardaron correctamente.");
      cerrarModal(); // Cerrar el modal despu√©s de guardar

      // Volver a cargar los datos (esperar a fetchReservas)
      await fetchReservas();
      await renderizarTablaChamba();

    } catch (error) {
      console.error("Error en la actualizaci√≥n:", error);
      alert("Ocurri√≥ un error al guardar los datos.");
    }
  }
  async function actualizarYCargarReservas() {
    await fetchReservas(); // Espera a que termine fetchReservas
    console.log('Reservas actualizadas');
  }
  // Inicializar la tabla al cargar la p√°gina
  //renderizarTablaChamba();

  async function actualizarYCargarReservas() {
    await fetchReservas(); // Espera a que termine fetchReservas
    console.log('Reservas actualizadas');
  }

  function formatFecha(fecha) {
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0'); // A√±adir ceros
    const day = String(fecha.getDate()).padStart(2, '0');
    const hours = String(fecha.getHours()).padStart(2, '0');
    const minutes = String(fecha.getMinutes()).padStart(2, '0');
    const seconds = String(fecha.getSeconds()).padStart(2, '0');

    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
  }
  function convertirAFechaISO(fechaString) {
    return fechaString.replace(/\//g, "-").replace(" ", "T");
  }
</script>